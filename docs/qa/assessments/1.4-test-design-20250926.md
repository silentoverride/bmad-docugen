# Test Design: Story 1.4

Date: 2025-09-26
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 3 (30.0%)
- Integration tests: 6 (60.0%)
- E2E tests: 1 (10.0%)
- Priority distribution: P0: 8, P1: 2, P2: 0

## Test Scenarios by Acceptance Criteria

### AC1: REST API endpoint accepts the same configuration payload as the CLI, validating input via shared schema modules.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                              | Justification                                                                                              |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 1.4-UNIT-001 | Unit        | P0       | API request validator reuses shared schema definitions and rejects payloads missing required fields | Ensures zero drift between CLI and API validation logic through fast, deterministic checks.               |
| 1.4-INT-001  | Integration | P0       | Invoke API with canonical payload and compare normalized request context to CLI behaviour           | Confirms shared orchestration path and equivalent normalization across interfaces.                         |
| 1.4-INT-002  | Integration | P0       | Invoke API with malformed payload and assert error structure/exit semantics mirror CLI             | Verifies parity for failure responses, preventing partner confusion during validation failures.           |

### AC2: Requests require authenticated service tokens with role scopes that mirror operator RBAC rules.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                | Justification                                                                                         |
| ------------ | ----------- | -------- | ----------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| 1.4-UNIT-002 | Unit        | P0       | Authorization middleware enforces scope-to-operation mapping                        | Pure logic best verified at unit level to detect drift quickly.                                       |
| 1.4-INT-003  | Integration | P0       | Token missing required scope returns 403 with audit-friendly error payload          | Exercises real auth pipeline and ensures partner misconfigurations fail safely.                       |
| 1.4-INT-004  | Integration | P0       | Expired or replayed token attempt results in 401 and traceable security log entries | Validates session management and replay protections noted in risk profile SEC-003.                    |

### AC3: API responses include run manifest identifiers and status links consistent with CLI outputs.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                             | Justification                                                                                                  |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- |
| 1.4-INT-005  | Integration | P0       | Successful API call returns manifest ID, hash, and status link that aligns with CLI manifest data | Critical parity check so partners can rely on CLI documentation and tooling.                                    |
| 1.4-E2E-001  | E2E         | P0       | End-to-end API-triggered job produces manifest retrievable via status link and matches CLI output | Validates complete partner journey including status polling expectations.                                      |

### AC4: OpenAPI specification and usage guide document request/response formats, auth setup, and rate limits.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                                          | Justification                                                                                                         |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| 1.4-UNIT-003 | Unit        | P1       | OpenAPI spec linting enforces documented examples, auth headers, and rate limit annotations                   | Documentation-focused test adds guardrails without impacting runtime paths.                                          |
| 1.4-INT-006  | Integration | P1       | Render usage guide and compare sample requests/responses against live API contract using contract testing tool | Ensures published documentation stays synchronized with real API behaviour for partner onboarding.                   |

## Risk Coverage

Targets security/auth risks (SEC-003), parity drift (TECH-005), status linkage gaps (DATA-005), and rate/usage documentation issues. Majority P0 tests ensure unauthorized access and response inconsistencies surface early.

## Recommended Execution Order

1. P0 unit tests (1.4-UNIT-001, 1.4-UNIT-002)
2. P0 integration tests (1.4-INT-001, 1.4-INT-002, 1.4-INT-003, 1.4-INT-004, 1.4-INT-005)
3. P0 E2E test (1.4-E2E-001)
4. P1 tests (1.4-UNIT-003, 1.4-INT-006)

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
