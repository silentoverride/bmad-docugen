# Test Design: Story 4.3

Date: 2025-09-26
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 3 (33.3%)
- Integration tests: 5 (55.6%)
- E2E tests: 1 (11.1%)
- Priority distribution: P0: 7, P1: 2, P2: 0

## Test Scenarios by Acceptance Criteria

### AC1: `docugen templates preview` executes dry-run render with deterministic seeds, producing PDFs and diff artefacts without touching production manifests.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                                 | Justification                                                                                               |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| 4.3-UNIT-001 | Unit        | P0       | Preview configuration enforces separate storage namespace and manifest prefixes                     | Direct mitigation for OPS-019 preventing production contamination.                                          |
| 4.3-INT-001  | Integration | P0       | Execute preview run and confirm artefacts stored in preview bucket with deterministic filenames     | Validates isolation boundaries and determinism.                                                             |
| 4.3-INT-002  | Integration | P0       | Negative test attempts to write preview artefact to production path and expects hard failure        | Ensures guardrails block misconfiguration.                                                                  |

### AC2: Preflight validation checks ensure templates respect reconciliation and compliance rules.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                               | Justification                                                                                           |
| ------------ | ----------- | -------- | -------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| 4.3-UNIT-002 | Unit        | P0       | Validation pipeline toggles ensure reconciliation and compliance checks execute for preview mode  | Prevents DATA-018 by enforcing validation coverage.                                                     |
| 4.3-INT-003  | Integration | P0       | Preview run with intentional violation confirms diagnostics emitted and run blocked               | Confirms parity with production gating behaviour.                                                      |
| 4.3-INT-004  | Integration | P1       | Metrics capture preview validation coverage status for dashboards                                 | Medium risk ensures observability of preview coverage.                                                 |

### AC3: Admin UI surfaces preview artefacts, diff reports, and validation status for stakeholders.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                           | Justification                                                                                             |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| 4.3-INT-005  | Integration | P0       | UI test verifies RBAC-protected preview artefact access, diff rendering, and realtime status   | Mitigates SEC-014 through access control and UX validation.                                              |
| 4.3-E2E-001  | E2E         | P0       | Stakeholder workflow from upload → preview run → UI review ensures approvals recorded          | Provides end-to-end confidence for review process and traceability.                                      |

### AC4: Monitoring emits preview run metrics (duration, diff outcomes, rule violations) retained for 30 days.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                           | Justification                                                                                               |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| 4.3-UNIT-003 | Unit        | P1       | Metrics exporter labels preview runs distinctly and enforces 30-day retention configuration   | Medium risk ensures retention is codified.                                                                  |
| 4.3-INT-006  | Integration | P0       | Synthetic preview load test measures resource usage and ensures production queue throttling     | Addresses PERF-013 by verifying quotas/backpressure when preview load spikes.                               |

## Risk Coverage

- OPS-019 mitigated via storage namespace unit test and negative integration check.
- DATA-018 addressed by validation pipeline unit/integration tests.
- SEC-014 covered through UI RBAC test and E2E stakeholder workflow.
- PERF-013 mitigated by synthetic load test verifying resource isolation.
- BUS-014 satisfied through E2E workflow capturing approvals.

## Recommended Execution Order

1. P0 unit tests (4.3-UNIT-001, 4.3-UNIT-002)
2. P0 integration tests (4.3-INT-001, 4.3-INT-002, 4.3-INT-003, 4.3-INT-005, 4.3-INT-006)
3. P0 E2E test (4.3-E2E-001)
4. P1 tests (4.3-INT-004, 4.3-UNIT-003)

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
