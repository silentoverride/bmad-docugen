# Test Design: Story 3.2

Date: 2025-09-26
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 3 (33.3%)
- Integration tests: 5 (55.6%)
- E2E tests: 1 (11.1%)
- Priority distribution: P0: 7, P1: 2, P2: 0

## Test Scenarios by Acceptance Criteria

### AC1: Structured logs emit to CloudWatch (or equivalent) with trace ids linking CLI actions, rule evaluations, and packaging events.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                        | Justification                                                                                       |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| 3.2-UNIT-001 | Unit        | P0       | Log formatter includes trace id, operator id, run manifest id across all events            | Ensures deterministic, auditable logging and mitigates OPS-011.                                     |
| 3.2-INT-001  | Integration | P0       | End-to-end run verifies logs emitted with correct schema into CloudWatch with trace linking | Critical for audit trail completeness.                                                             |

### AC2: Manifests and bundles persist to S3 with KMS encryption, retention policies, and integrity hashes checked on retrieval.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                              | Justification                                                                                                  |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| 3.2-UNIT-002 | Unit        | P0       | Storage configuration enforces encryption context and retention policy validation                | Prevents misconfiguration of KMS/bucket policies (SEC-009 mitigation).                                            |
| 3.2-INT-002  | Integration | P0       | Upload manifest/bundle and confirm KMS encryption, retention tags, and checksum recording        | Validates storage boundary end to end.                                                                          |
| 3.2-INT-003  | Integration | P0       | Retrieval API recalculates checksum and compares to stored hash, failing on mismatch            | Ensures integrity check enforced on access, mitigating DATA-011.                                                |

### AC3: Access logs capture every download or manifest view with operator identity and timestamp.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                       | Justification                                                                                           |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| 3.2-INT-004  | Integration | P0       | Simulate manifest download via CLI/UI and verify access log entry includes operator identity | Critical for audit traceability and OPS-011 control.                                                  |
| 3.2-E2E-001  | E2E         | P1       | Full evidence retrieval flow confirms logs, manifests, and alerts integrate across systems    | Ensures cross-surface behaviour for auditors; slightly lower risk after integration tests.            |

### AC4: Disaster recovery procedure documents restoration steps and validates quarterly via tabletop exercise.

#### Scenarios

| ID           | Level       | Priority | Test                                                                                       | Justification                                                                                      |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| 3.2-UNIT-003 | Unit        | P1       | Documentation lint ensures DR runbook references current infrastructure and contact details | Medium risk; ensures documentation accuracy.                                                       |
| 3.2-INT-005  | Integration | P0       | DR rehearsal simulation restores manifests/bundles from backups and captures evidence logs  | Critical to mitigate OPS-012 by proving recovery workflow.                                         |

## Risk Coverage

- SEC-009 covered by encryption configuration unit test and upload verification.
- DATA-011 mitigated through checksum enforcement integration test.
- OPS-011 addressed by log schema verification and download logging tests.
- OPS-012 handled via DR rehearsal integration scenario.

## Recommended Execution Order

1. P0 unit tests (3.2-UNIT-001, 3.2-UNIT-002)
2. P0 integration tests (3.2-INT-001, 3.2-INT-002, 3.2-INT-003, 3.2-INT-004, 3.2-INT-005)
3. P1 tests (3.2-E2E-001, 3.2-UNIT-003)

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
