# Risk Profile: Story 1.4

Date: 2025-09-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5
- Critical Risks: 1
- High Risks: 3
- Risk Score: 45/100

Story 1.4 exposes the external API surface that mirrors CLI functionality. Security posture and behavioural parity are paramount: any weakness in authentication, manifest parity, or rate limiting propagates to partner integrations and multiplies operational load.

## Critical Risks Requiring Immediate Attention

### 1. SEC-003: Insufficient API Authentication & Authorization Controls
**Score:** 9 (Critical)

- **Probability:** High (3) – Early iterations often reuse internal tokens or skip scope enforcement while waiting for identity integration.
- **Impact:** High (3) – Unauthorized access could trigger arbitrary document generation, leak manifests, or exhaust infrastructure resources, creating material security incidents.
- **Mitigation:**
  - Enforce OAuth2 client credentials with scoped service tokens bound to partner entitlements.
  - Validate scopes on every request path; reject tokens lacking required roles with auditable errors.
  - Add penetration testing and threat modelling before external enablement.
- **Testing Focus:** Security integration tests covering happy path, scope violations, expired tokens, and replay attempts.

## High-Risk Items

### 2. TECH-005: API and CLI Validation Drift
**Score:** 6 (High)

- **Probability:** Medium (2) – Separate code paths or serialization layers can introduce subtle differences over time.
- **Impact:** High (3) – Partners may receive approvals/rejections inconsistent with CLI, eroding trust and complicating debugging.
- **Mitigation:**
  - Reuse shared orchestrator module (Story 1.2) directly inside API handlers.
  - Add contract tests executing identical payloads through CLI and API, diffing responses and manifests.
  - Introduce shared response schema definitions enforced at compile time.
- **Testing Focus:** Integration parity tests comparing CLI vs API outputs for golden fixtures.

### 3. DATA-005: Manifest Status Linkage Gaps
**Score:** 6 (High)

- **Probability:** High (3) – Asynchronous processing and queue hand-offs (Story 1.5) complicate status propagation.
- **Impact:** Medium (2) – Clients may poll stale or missing status endpoints, causing retries, support tickets, or double submissions.
- **Mitigation:**
  - Define consistent state machine for manifest lifecycle with storage-backed status updates.
  - Document and test status polling workflow, including eventual consistency expectations.
  - Ensure API responses include signed URLs or IDs resolvable via orchestrator logs.
- **Testing Focus:** Integration tests simulating queued jobs and verifying status transitions plus polling responses.

### 4. PERF-003: Rate Limiting Misconfiguration
**Score:** 6 (High)

- **Probability:** Medium (2) – Rate limiting often delayed until load testing or relies on defaults incompatible with partner burst patterns.
- **Impact:** High (3) – Missing limits enables abuse/DoS; overly aggressive limits block legitimate partner usage and trigger support escalations.
- **Mitigation:**
  - Implement adaptive rate limiting (token bucket) with partner-specific quotas.
  - Instrument usage metrics and alert on limit breaches or throttling spikes.
  - Provide documented fallback procedures and feature flags for emergency adjustments.
- **Testing Focus:** Load tests exploring burst and sustained traffic, plus validation of throttled responses.

## Medium-Risk Items

### 5. OPS-004: Insufficient API Observability & Alerting
**Score:** 4 (Medium)

- **Probability:** Medium (2) – New services often ship with minimal logging or dashboards.
- **Impact:** Medium (2) – Failures or abuse may go undetected, delaying incident response and SLA commitments.
- **Mitigation:**
  - Define logging schema including correlation IDs, partner IDs, and manifest references.
  - Wire dashboards tracking success rate, latency, and error taxonomy; set alert thresholds.
  - Exercise incident runbooks via game days before production launch.
- **Testing Focus:** Observability tests ensuring traces, logs, and metrics propagate through monitoring stack.

## Risk Distribution

### By Category
- Security: 1 risk (1 critical)
- Technical: 1 risk (0 critical, 1 high)
- Data: 1 risk (0 critical, 1 high)
- Performance: 1 risk (0 critical, 1 high)
- Operational: 1 risk (0 critical, 0 high, 1 medium)
- Business: 0 risks (0 critical)

### By Component
- Auth service integration: 1 risk
- API orchestration layer: 2 risks
- Rate limiting infrastructure: 1 risk
- Observability stack: 1 risk

## Risk Matrix

| Risk ID  | Description                                  | Probability | Impact | Score | Priority |
|----------|----------------------------------------------|-------------|--------|-------|----------|
| SEC-003  | Insufficient API authentication/authorization | High (3)    | High (3) | 9   | Critical |
| TECH-005 | API and CLI validation drift                  | Medium (2)  | High (3) | 6   | High     |
| DATA-005 | Manifest status linkage gaps                  | High (3)    | Medium (2) | 6 | High     |
| PERF-003 | Rate limiting misconfiguration                | Medium (2)  | High (3) | 6   | High     |
| OPS-004  | Insufficient API observability & alerting     | Medium (2)  | Medium (2) | 4 | Medium   |

## Detailed Risk Register

| Risk ID  | Category | Components Affected                       | Detection Method                            | Mitigation Owner      | Residual Risk |
|----------|----------|-------------------------------------------|---------------------------------------------|-----------------------|----------------|
| SEC-003  | Security | Identity provider, API gateway            | Penetration tests, security architecture review | Security Engineering  | Low with enforced scopes |
| TECH-005 | Technical | API handlers, orchestrator module       | CLI/API parity automation, contract tests  | Platform Engineering  | Medium – parity must be monitored |
| DATA-005 | Data     | Manifest storage, status endpoints        | Integration tests, queue smoke tests        | Queue/API Integration | Medium – linked to queue maturity |
| PERF-003 | Performance | Rate limiter, API gateway, worker pool | Load testing, production telemetry          | SRE/Platform          | Medium – requires ongoing tuning |
| OPS-004  | Operational | Logging/metrics pipeline              | Observability smoke tests, dashboard audits | SRE                   | Low once instrumentation lands |

## Risk-Based Testing Strategy

### Priority 1: Critical & High Risks
- Security test suite enforcing token scope, expiry, and replay protections (SEC-003).
- CLI/API parity integration tests for shared payloads (TECH-005).
- Status transition tests with queued jobs plus load tests verifying rate limiting behaviour (DATA-005, PERF-003).

### Priority 2: Medium Risks
- Observability validation ensuring metrics, logs, and traces populate dashboards and trigger alerts (OPS-004).

### Priority 3: Baseline Regression
- API contract tests ensuring OpenAPI specification matches implementation.
- Smoke tests covering error handling, malformed payloads, and throttled responses.

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-003 must be mitigated with scoped auth, monitoring, and security review.
- TECH-005 must demonstrate parity with CLI on golden fixtures prior to partner onboarding.

### Can Deploy with Mitigation
- DATA-005 acceptable with documented eventual consistency and robust polling contract tests.
- PERF-003 acceptable when rate limiting instrumentation and emergency controls exist.
- OPS-004 acceptable if observability backlog is short and monitored until completion.

### Accepted Risks
- None currently accepted; revisit once partner pilots begin.

## Monitoring Requirements
- Track authentication success/failure rates, scope violations, and token expirations.
- Monitor request latency, throttle counts, and manifest state transitions.
- Configure alerts for error-rate spikes, SLA breaches, and anomalous traffic.

## Risk Review Triggers
- New partner integration or scope expansion.
- Changes to orchestrator logic affecting manifests or status flows.
- Rate limiting parameter adjustments or infrastructure migration.

## Recommendations Summary
- Harden authentication and scope enforcement before exposing the API.
- Automate parity checks between API and CLI responses to prevent drift.
- Instrument the service thoroughly so SREs can react quickly to partner issues.

Risk profile: docs/qa/assessments/1.4-risk-20250926.md
