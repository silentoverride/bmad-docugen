# Risk Profile: Story 2.2

Date: 2025-09-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5
- Critical Risks: 1
- High Risks: 2
- Risk Score: 48/100

Merchant and employer enrichment introduces external dependencies that can jeopardise determinism and data privacy. The most acute exposure is caching unpredictability under quota pressure, which would derail reproducible outputs promised across Epic 1.

## Critical Risks Requiring Immediate Attention

### 1. DATA-008: Non-Deterministic Enrichment Responses Under Quota Pressure
**Score:** 9 (Critical)

- **Probability:** High (3) – Google Places latency, partial responses, or stale cache hydration frequently create divergent payloads.
- **Impact:** High (3) – Breaks deterministic guarantees, causing mismatched manifests and checksum failures across runs.
- **Mitigation:**
  - Normalize responses (field ordering, null handling) before caching; cache miss policy must fall back deterministically.
  - Implement replay tests comparing online/offline outputs for golden personas.
  - Add circuit breaker that forces fallback dataset when quotas degrade response consistency.
- **Testing Focus:** Integration tests simulating quota exhaustion and response variance; determinism diff suite comparing repeated runs.

## High-Risk Items

### 2. SEC-006: Leakage of API Keys or Enriched Data
**Score:** 6 (High)

- **Probability:** Medium (2) – Logging enriched payloads or misconfigured cache encryption can expose sensitive employer metadata.
- **Impact:** High (3) – Violates privacy commitments and may breach Google Places terms or local regulations.
- **Mitigation:**
  - Store cache entries encrypted at rest with key rotation; mask sensitive fields in logs/telemetry.
  - Restrict API keys via least-privilege IAM and monitor usage anomalies.
  - Run security reviews focusing on data flow diagrams and logging sinks.
- **Testing Focus:** Security penetration tests on cache storage; audit logging tests verifying redaction.

### 3. OPS-007: Offline Dataset Becomes Stale or Coverage Gaps Appear
**Score:** 6 (High)

- **Probability:** Medium (2) – Without operational upkeep, fallback dataset will drift from real-world employer landscape.
- **Impact:** High (3) – Leads to obviously incorrect artefacts, escalating support load and reducing trust in deterministic outputs.
- **Mitigation:**
  - Establish update cadence with data owners, including automated validation against real merchant samples.
  - Version offline dataset with manifest references and change logs.
  - Monitor fallback usage frequency to trigger refresh workflows.
- **Testing Focus:** Data quality checks comparing fallback entries against compliance sample sets; monitoring tests verifying alert triggers on stale data.

## Medium-Risk Items

### 4. TECH-008: Cache Invalidation Bugs Cause Excess API Calls
**Score:** 4 (Medium)

- **Probability:** Medium (2) – TTL misconfiguration or race conditions may bypass cache.
- **Impact:** Medium (2) – Increases costs, risks quota exhaustion, and slows bundle generation.
- **Mitigation:**
  - Use deterministic cache keys derived from normalized inputs; include lock mechanisms for concurrent refreshes.
  - Add metrics on cache hit rate and TTL behaviour with alerting on anomalies.
  - Include chaos testing that clears caches to validate graceful degradation.
- **Testing Focus:** Unit tests on cache key generation; integration tests measuring cache hit ratios under load.

### 5. BUS-004: Enrichment Overrides Lack Audit Trail
**Score:** 4 (Medium)

- **Probability:** Medium (2) – Manual overrides for merchants/employers may be logged informally.
- **Impact:** Medium (2) – Compromises auditability and undermines evidence packages in Epic 5.
- **Mitigation:**
  - Record overrides in manifests with operator identity, timestamp, and reason.
  - Require approval workflow or change management for overrides.
  - Surface override counts in compliance dashboards for monitoring.
- **Testing Focus:** Manifest contract tests including override metadata; integration tests verifying approval flow.

## Risk Distribution

### By Category
- Data: 2 risks (1 critical, 1 high)
- Security: 1 risk (0 critical, 1 high)
- Operational: 1 risk (0 critical, 1 high)
- Technical: 1 risk (0 critical, 0 high, 1 medium)
- Business: 1 risk (0 critical, 0 high, 1 medium)
- Performance: 0 risks

### By Component
- Enrichment pipeline: 3 risks
- Cache layer: 1 risk
- Governance/logging: 1 risk

## Risk Matrix

| Risk ID  | Description                                         | Probability | Impact | Score | Priority |
|----------|-----------------------------------------------------|-------------|--------|-------|----------|
| DATA-008 | Non-deterministic enrichment responses              | High (3)    | High (3) | 9   | Critical |
| SEC-006  | Leakage of API keys or enriched data                | Medium (2)  | High (3) | 6   | High     |
| OPS-007  | Offline dataset becomes stale or incomplete         | Medium (2)  | High (3) | 6   | High     |
| TECH-008 | Cache invalidation bugs cause excess API calls      | Medium (2)  | Medium (2) | 4 | Medium   |
| BUS-004  | Enrichment overrides lack audit trail               | Medium (2)  | Medium (2) | 4 | Medium   |

## Detailed Risk Register

| Risk ID  | Category | Components Affected                 | Detection Method                                  | Mitigation Owner      | Residual Risk |
|----------|----------|-------------------------------------|---------------------------------------------------|-----------------------|----------------|
| DATA-008 | Data     | Enrichment client, cache, fallback  | Determinism diff tests, quota simulations         | Platform Engineering  | Low once safeguards in place |
| SEC-006  | Security | Cache storage, logging, API keys    | Security audit, credential scanning, pentests     | Security Engineering  | Medium – ongoing monitoring needed |
| OPS-007  | Operational | Fallback dataset governance      | Data quality reports, usage telemetry             | Operations/Compliance | Medium – reliant on refresh cadence |
| TECH-008 | Technical | Cache invalidation logic, TTLs     | Cache hit metrics, chaos testing                  | Platform Engineering  | Medium – concurrency complexity |
| BUS-004  | Business | Manifest logging, override workflow | Manifest audits, compliance review                | Product & Compliance  | Low with mandated workflow |

## Risk-Based Testing Strategy

### Priority 1: Critical & High Risks
- Determinism regression comparing online/offline enrichment outputs (DATA-008).
- Security-focused integration tests on encrypted cache storage and key handling (SEC-006).
- Operational tests verifying fallback dataset freshness alerts (OPS-007).

### Priority 2: Medium Risks
- Cache behaviour tests under TTL churn (TECH-008).
- Manifest override logging tests (BUS-004).

### Priority 3: Baseline Regression
- Unit tests for Google Places client wrappers and normalization utilities.
- Smoke tests running enrichment pipeline in offline-only mode.

## Risk Acceptance Criteria

### Must Fix Before Production
- DATA-008 mitigations must be proven via determinism testing.
- SEC-006 controls must be operationally validated.

### Can Deploy with Mitigation
- OPS-007 acceptable with documented refresh cadence and monitoring backlog.
- TECH-008 and BUS-004 acceptable when captured in operational runbooks and automated checks.

### Accepted Risks
- None currently accepted.

## Monitoring Requirements
- Track cache hit/miss rates, fallback usage, and override counts in observability dashboards.
- Alert on API quota consumption spikes or cache encryption failures.

## Risk Review Triggers
- Changes to Google Places API terms or quotas.
- Addition of new enrichment providers or data attributes.
- Discovery of stale fallback entries during QA or compliance review.

## Recommendations Summary
- Enforce deterministic normalization and fallback strategies.
- Secure enrichment data flows rigorously, including cache encryption and key management.
- Govern fallback dataset freshness and override logging through automation.

Risk profile: docs/qa/assessments/2.2-risk-20250926.md
